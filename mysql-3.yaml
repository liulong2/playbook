---
- name: mysql
  hosts: mysql3
  become: true
  become_user: root
  vars:

  tasks:
    #解决 pip安装时报错
#    - name: yum clean all
#      shell: "yum clean all"
#    - name: yum clean all
#      shell: "rpm --rebuilddb"
##    - name: upgrade all packages
##      yum:
##        name: "*"
##        state: latest
#    - name: yum remove epel-release
#      yum:
#        name: epel-release
#        state: removed
#暂时注释
#    - name: yum -y install epel-release
#      shell: "yum -y install epel-release"
#    - name: installed pip
#      yum:
#        name: python-pip
#        state: latest
#    - name: update pip
#      shell: "pip install --upgrade pip"
#
#
#    - name: weget
#      shell: "wget -P /usr/local/yum http://repo.mysql.com/yum/mysql-5.7-community/el/7/x86_64/mysql57-community-release-el7-10.noarch.rpm"
#        #        state: installed
#        #        shell: "wget: http://repo.mysql.com/mysql-community-release-el7-5.noarch.rpm"
#    - name: rpm
#      shell: chdir=/usr/local/yum  executeble="rpm -ivh mysql57-community-release-el7-10.noarch.rpm"
#
#    - name: Installed mysql-devel
#      yum:
#        name: mysql-devel
#        state: present
#
#    - name: gcc
#      yum:
#        name: gcc
#        state: installed
#  #      shell: "yum install gcc"
#    - name: MySQL-python
#      #      yum:
#      #        name: MySQL-python
#      #      #        state: installed
#      #        state: installed
#      pip:
#        name: MySQL-python


    - name: dump a database
      mysql_db:
#        login_host: "{{hostvars['mysql3']['ansible_default_ipv4']['address']}}"
        login_user: root
        login_password: "root"
        login_port: 3306
        name: all
        target: /tmp/mezz1.gz
        state: "dump"
#      loop: "{{packages}}"
    - name: ip
      debug: var=ansible_default_ipv4
    - name: name
      debug: var=ansible_hostname
#      .address
    - name: fetch6
      fetch:
        dest: /back/lib/ss-{{ inventory_hostname }}-{{ansible_date_time.date}}.sql
        src: /tmp/mezz1.gz
        flat: yes
#    - name: copy
#      copy:
#        src: /tmp/ss-{{ inventory_hostname }}.sql
#        dest: /usr/
#    - name: dump a database
#      mysql_db:
#        login_host: 192.168.0.207
#        login_user: root
#        login_password: "root"
#        login_port: 3306
#        name: all
#        target: /tmp/mezz.sql
#        state: "dump"
#    - name: fetch
#      fetch:
#        dest: /tmp/
#        src: /tmp/mezz.sql
- name: mysql
  hosts: mysql4
  become: true
  become_user: root
  vars:
  tasks:
    - name: loop
      debug: var = "{{item.ip}}"
      loop: "{{packages}}"
    - name: mysql
      mysql_db:
        login_host: "{{item.ip}}"
        login_user: "{{item.username}}"
        login_password: "{{item.password}}"
        login_port: 3306
        name: all
        target: /tmp/mezz1.sql
        state: "dump"
      when: item.ip != ("192.168.0.166" or "47.104.94.50")
      loop: "{{packages}}"
    - name: shell mysqldump
      shell: mysqldump --column-statistics=0 -h 192.168.0.166 -u root -p --all-databases > db.sql
      when: item.ip == ("192.168.0.166" or "47.104.94.50")
      loop: "{{packages}}"
    - name: fetch6
      fetch:
        dest: "/back/lib/ss-{{item.ip}}-{{ansible_date_time.date}}.sql"
        src: /tmp/mezz1.gz
        flat: yes
      loop: "{{packages}}"

# mysqldump --column-statistics=0 -h 192.168.0.166 -u root -p --all-databases > db.sql
